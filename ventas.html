<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Ventas - PRIVADO</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #2c2c2c; color: white; font-family: Arial, sans-serif; }
    .login-screen { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; 
      z-index: 1000;
    }
    .login-box { 
      background: #3c3c3c; padding: 2em; border-radius: 10px; text-align: center; 
      border: 2px solid #555; box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .login-box input { 
      background: #555; color: white; border: 1px solid #777; padding: 0.8em; 
      margin: 0.5em; font-size: 1.2em; border-radius: 5px; text-align: center;
    }
    .login-box button { 
      background: #4caf50; color: white; border: none; padding: 0.8em 2em; 
      font-size: 1.2em; border-radius: 5px; cursor: pointer; margin: 0.5em;
    }
    .login-box button:hover { background: #45a049; }
    .error { color: #f44336; margin-top: 0.5em; }
    .main-content { display: none; }
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin: 1em 0; }
    .stat-box { background: #3c3c3c; border: 1px solid #555; padding: 1em; border-radius: 5px; }
    .stat-number { font-size: 2em; font-weight: bold; color: #4caf50; }
    .productos-table { background: #3c3c3c; border: 1px solid #555; padding: 1em; border-radius: 5px; margin: 1em 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #555; padding: 0.5em; text-align: center; }
    th { background: #4c4c4c; }
    .beneficio { color: #4caf50; }
    .coste { color: #f44336; }
    .config { background: #1a1a2e; padding: 1em; border-radius: 5px; margin: 1em 0; }
    input { background: #555; color: white; border: 1px solid #777; padding: 0.3em; }
    .logout-btn { 
      position: fixed; top: 10px; right: 10px; background: #f44336; 
      border: none; color: white; padding: 0.5em 1em; border-radius: 5px; cursor: pointer;
    }
    .venta-detalle { 
      background: #2a2a2a; border: 1px solid #555; margin: 0.5em 0; 
      padding: 1em; border-radius: 5px; border-left: 4px solid #4caf50;
    }
    .venta-header { 
      font-weight: bold; color: #4caf50; margin-bottom: 0.5em; 
      display: flex; justify-content: space-between; align-items: center;
    }
    .venta-items { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin: 0.5em 0; }
    .venta-total { text-align: right; font-weight: bold; color: #81c784; }
  </style>
</head>
<body>
  <!-- Pantalla de login -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h2>üîí Acceso Restringido</h2>
      <p>Introduce la contrase√±a para acceder al dashboard</p>
      <input type="password" id="passwordInput" placeholder="Contrase√±a" maxlength="50">
      <br>
      <button onclick="verificarPassword()">Entrar</button>
      <div id="errorMessage" class="error"></div>
    </div>
  </div>

  <!-- Contenido principal (oculto inicialmente) -->
  <div id="mainContent" class="main-content">
    <button class="logout-btn" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
    
    <h1>üìä Dashboard de Ventas</h1>
  
  <div class="config">
    <h3>‚öôÔ∏è Configuraci√≥n</h3>
    <label>Porcentaje de Beneficio: <input type="number" id="porcentaje" value="15" min="0" max="100"> %</label>
    <button onclick="actualizarPorcentaje()">Actualizar</button>
    <button onclick="mostrarEditarCostes()">‚úèÔ∏è Editar Costes</button>
    <button onclick="forzarInicializacion()" style="background: #9c27b0;">üî• Forzar Inicio</button>
    <button onclick="exportarConfiguracion()">üìÑ Exportar Config JSON</button>
    <button onclick="exportarDatos()">üì• Exportar Todo</button>
    <button onclick="resetearSistema()" style="background: #ff9800;">üîÑ Reset Sistema</button>
    <button onclick="borrarTodo()" style="background: #d32f2f;">üóëÔ∏è Borrar Ventas</button>
  </div>
  
  <!-- Panel de edici√≥n de costes (oculto inicialmente) -->
  <div id="panelCostes" style="display: none; background: #1a1a2e; padding: 1em; border-radius: 5px; margin: 1em 0;">
    <h3>üí∞ Editar Costes</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
      <div>
        <h4>Productos:</h4>
        <div id="costesProductos"></div>
      </div>
      <div>
        <h4>Decisiones:</h4>
        <div id="costesDecisiones"></div>
      </div>
    </div>
    <button onclick="guardarCostes()">üíæ Guardar Costes</button>
    <button onclick="cerrarEditarCostes()">‚ùå Cerrar</button>
  </div>
  
  <div class="dashboard">
    <div class="stat-box">
      <div class="stat-number" id="totalVentas">0</div>
      <div>Total Ventas</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="ingresosTotales">0 ‚Ç¨</div>
      <div>Ingresos Totales</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="costesTotales">0 ‚Ç¨</div>
      <div>Costes Totales</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="beneficioNeto">0 ‚Ç¨</div>
      <div>Beneficio Neto</div>
    </div>
  </div>
  
  <div class="dashboard">
    <div class="stat-box">
      <div class="stat-number" id="media">0 ‚Ç¨</div>
      <div>Media por Venta</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="mediana">0 ‚Ç¨</div>
      <div>Mediana</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="moda">0 ‚Ç¨</div>
      <div>Moda</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="desviacion">0 ‚Ç¨</div>
      <div>Desviaci√≥n Est√°ndar</div>
    </div>
  </div>
  
  <div class="productos-table">
    <h3>üè∑Ô∏è An√°lisis por Categor√≠a</h3>
    <table id="tablaCategorias">
      <thead>
        <tr>
          <th>Categor√≠a</th>
          <th>Ventas</th>
          <th>Ingresos</th>
          <th>Costes</th>
          <th>Beneficio</th>
          <th>Margen %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <div class="productos-table">
    <h3>üìà An√°lisis por Producto</h3>
    <table id="tablaProductos">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Ventas</th>
          <th>Ingresos</th>
          <th>Costes</th>
          <th>Beneficio</th>
          <th>Margen %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <div class="productos-table">
    <h3>üéØ An√°lisis por Decisi√≥n</h3>
    <table id="tablaDecisiones">
      <thead>
        <tr>
          <th>Decisi√≥n</th>
          <th>Ventas</th>
          <th>Ingresos</th>
          <th>Costes</th>
          <th>Beneficio</th>
          <th>Margen %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <div class="productos-table">
    <h3>üìã Detalle de Ventas Individuales</h3>
    <div id="ventasDetalle"></div>
  </div>
  
  <script>
    // Configuraci√≥n del servidor
        // Configuraci√≥n din√°mica de API
    const API_CONFIG = {
      // Detectar autom√°ticamente si estamos en desarrollo local o servidor remoto
      getBaseURL: function() {
        const hostname = window.location.hostname;
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1';
        
        if (isLocal) {
          // Desarrollo local - usar servidor Python
          return 'http://127.0.0.1:5001';
        } else {
          // Servidor remoto - usar API PHP
          return window.location.origin;
        }
      },
      
      getAPIEndpoint: function(endpoint) {
        const baseURL = this.getBaseURL();
        const hostname = window.location.hostname;
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '::1';
        
        if (isLocal) {
          // Desarrollo local - endpoints Python
          return `${baseURL}/api/${endpoint}`;
        } else {
          // Servidor remoto - endpoints PHP
          return `${baseURL}/api.php/${endpoint}`;
        }
      }
    };

    console.log('üåê Dashboard - Configuraci√≥n de API:', {
      hostname: window.location.hostname,
      isLocal: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',
      baseURL: API_CONFIG.getBaseURL(),
      example: API_CONFIG.getAPIEndpoint('configuracion')
    });
    
    // Sistema de autenticaci√≥n
    const PASSWORD_CORRECTA = "Blender 3D."; // Contrase√±a para acceder
    let sesionActiva = false;
    
    function verificarPassword() {
      const password = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('errorMessage');
      
      if (password === PASSWORD_CORRECTA) {
        sesionActiva = true;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        // Guardar sesi√≥n por 1 hora
        localStorage.setItem('sesionVentas', Date.now() + (60 * 60 * 1000));
        
        // Inicializar dashboard
        inicializarDashboard();
      } else {
        errorDiv.textContent = '‚ùå Contrase√±a incorrecta';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }
    
    function cerrarSesion() {
      sesionActiva = false;
      localStorage.removeItem('sesionVentas');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('passwordInput').value = '';
      document.getElementById('errorMessage').textContent = '';
    }
    
    function verificarSesion() {
      const sesionGuardada = localStorage.getItem('sesionVentas');
      
      if (sesionGuardada && Date.now() < parseInt(sesionGuardada)) {
        // Sesi√≥n v√°lida
        sesionActiva = true;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        inicializarDashboard();
      } else {
        // Sesi√≥n expirada o no existe
        localStorage.removeItem('sesionVentas');
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
      }
    }
    
    // Permitir Enter para hacer login
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verificarPassword();
      }
    });
    
    function inicializarDashboard() {
      console.log('Inicializando dashboard...');
      cargarConfiguracion().then(() => {
        console.log('Configuraci√≥n cargada, iniciando carga de ventas...');
        cargarVentas();
        // Actualizar cada 5 segundos
        setInterval(() => {
          if (sesionActiva) {
            console.log('Actualizando datos...');
            cargarVentas();
          }
        }, 5000);
      }).catch(error => {
        console.error('Error en inicializaci√≥n:', error);
        // Intentar continuar de todos modos
        crearConfiguracionDefecto();
        cargarVentas();
      });
    }
    
    // Variables globales
    let configuracion = {};
    
    function cargarConfiguracion() {
      console.log('üîß Cargando configuraci√≥n desde servidor...');
      
      // Cargar desde el servidor usando configuraci√≥n din√°mica
      return fetch(API_CONFIG.getAPIEndpoint('configuracion'))
        .then(response => response.json())
        .then(config => {
          configuracion = config;
          console.log('‚úÖ Configuraci√≥n cargada desde servidor:', configuracion);
          document.getElementById('porcentaje').value = configuracion.porcentajeBeneficio;
        })
        .catch(error => {
          console.error('‚ùå Error al cargar configuraci√≥n del servidor:', error);
          console.log('‚ö†Ô∏è Usando configuraci√≥n por defecto');
          crearConfiguracionDefecto();
        });
    }
    
    function crearConfiguracionDefecto() {
      console.log('üèóÔ∏è Creando configuraci√≥n por defecto');
      configuracion = {
        porcentajeBeneficio: 15,
        costes: {
          "Manzana": 2.5,
          "Banana": 1.5,
          "Naranja": 2.0,
          "Pera": 1.0,
          "Uva": 3.0
        },
        costeDecisiones: {
          "Decisi√≥n A": 5,
          "Decisi√≥n B": 10,
          "Decisi√≥n C": 15,
          "Decisi√≥n D": 20
        }
      };
      
      // Guardar inmediatamente en localStorage
      localStorage.setItem('configuracionVentas', JSON.stringify(configuracion));
      console.log('‚úÖ Configuraci√≥n por defecto guardada en localStorage');
    }
    
    function actualizarPorcentaje() {
      const nuevoPorcentaje = parseFloat(document.getElementById('porcentaje').value);
      configuracion.porcentajeBeneficio = nuevoPorcentaje;
      
      // Guardar en el servidor
      fetch(API_CONFIG.getAPIEndpoint('configuracion'), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(configuracion)
      })
      .then(response => response.json())
      .then(() => {
        console.log('‚úÖ Configuraci√≥n actualizada en servidor');
        // Tambi√©n guardar en localStorage como backup
        localStorage.setItem('configuracionVentas', JSON.stringify(configuracion));
        cargarVentas();
      })
      .catch(error => {
        console.error('‚ùå Error al guardar configuraci√≥n en servidor:', error);
        // Fallback a localStorage
        localStorage.setItem('configuracionVentas', JSON.stringify(configuracion));
        cargarVentas();
      });
    }
    
    function calcularEstadisticas(valores) {
      if (valores.length === 0) return { media: 0, mediana: 0, moda: 0, desviacion: 0 };
      
      // Media
      const media = valores.reduce((a, b) => a + b, 0) / valores.length;
      
      // Mediana
      const ordenados = [...valores].sort((a, b) => a - b);
      const medio = Math.floor(ordenados.length / 2);
      const mediana = ordenados.length % 2 === 0 
        ? (ordenados[medio - 1] + ordenados[medio]) / 2 
        : ordenados[medio];
      
      // Moda
      const frecuencias = {};
      valores.forEach(v => frecuencias[v] = (frecuencias[v] || 0) + 1);
      const maxFrecuencia = Math.max(...Object.values(frecuencias));
      const modas = Object.keys(frecuencias).filter(k => frecuencias[k] === maxFrecuencia);
      const moda = parseFloat(modas[0]) || 0;
      
      // Desviaci√≥n est√°ndar
      const varianza = valores.reduce((acc, val) => acc + Math.pow(val - media, 2), 0) / valores.length;
      const desviacion = Math.sqrt(varianza);
      
      return { media, mediana, moda, desviacion };
    }
    
    function cargarVentas() {
      // Asegurar que la configuraci√≥n existe
      if (!configuracion || Object.keys(configuracion).length === 0) {
        console.log('Configuraci√≥n no encontrada, creando por defecto');
        crearConfiguracionDefecto();
      }
      
      console.log('üîÑ Intentando cargar ventas desde:', API_CONFIG.getAPIEndpoint('ventas'));
      
      // Cargar ventas directamente desde el endpoint de ventas
      fetch(API_CONFIG.getAPIEndpoint('ventas'))
        .then(response => {
          console.log('üì° Respuesta del servidor:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.json();
        })
        .then(ventas => {
          console.log('‚úÖ Ventas cargadas desde servidor:', ventas.length);
          console.log('üìä Datos de ventas recibidos:', ventas);
          procesarYMostrarVentas(ventas);
        })
        .catch(error => {
          console.error('‚ùå Error al cargar ventas del servidor:', error);
          // Fallback a localStorage si el servidor no responde
          const ventas = JSON.parse(localStorage.getItem('ventas') || '[]');
          console.log('üì¶ Usando datos de localStorage como fallback:', ventas.length);
          procesarYMostrarVentas(ventas);
        });
    }

    function procesarYMostrarVentas(ventas) {
      // Debug: mostrar en consola
      console.log('Ventas a procesar:', ventas.length);
      console.log('Primera venta de ejemplo:', ventas[0]);
      console.log('Configuraci√≥n actual:', configuracion);
      
      if (ventas.length === 0) {
        document.getElementById('totalVentas').textContent = '0';
        document.getElementById('ingresosTotales').textContent = '0 ‚Ç¨';
        document.getElementById('costesTotales').textContent = '0 ‚Ç¨';
        document.getElementById('beneficioNeto').textContent = '0 ‚Ç¨';
        document.getElementById('media').textContent = '0 ‚Ç¨';
        document.getElementById('mediana').textContent = '0 ‚Ç¨';
        document.getElementById('moda').textContent = '0 ‚Ç¨';
        document.getElementById('desviacion').textContent = '0 ‚Ç¨';
        
        // Limpiar tablas
        document.querySelector('#tablaCategorias tbody').innerHTML = '<tr><td colspan="6">No hay datos</td></tr>';
        document.querySelector('#tablaProductos tbody').innerHTML = '<tr><td colspan="6">No hay datos</td></tr>';
        document.querySelector('#tablaDecisiones tbody').innerHTML = '<tr><td colspan="6">No hay datos</td></tr>';
        document.getElementById('ventasDetalle').innerHTML = '<p>No hay ventas registradas</p>';
        return;
      }
      
      // Estad√≠sticas generales - NUEVO FORMATO
      const totalVentas = ventas.length;
      let ingresosTotales = 0;
      let costesTotales = 0;
      
      // Calcular totales correctamente para el nuevo formato
      ventas.forEach(venta => {
        // El nuevo sistema usa precioFinal
        ingresosTotales += venta.precioFinal || venta.total || 0;
        
        // Costos del nuevo sistema (costo + ajustes si aplica)
        if (venta.costo !== undefined) {
          costesTotales += venta.costo;
        } else {
          // Sistema anterior - usar configuraci√≥n de costos
          if (venta.casillas) {
            venta.casillas.forEach(casilla => {
              costesTotales += configuracion.costes[casilla.nombre] || 0;
            });
          }
          if (venta.decision) {
            const nombreDecision = venta.decision.nombre ? venta.decision.nombre.split(' (')[0] : 'Decision';
            costesTotales += configuracion.costeDecisiones[nombreDecision] || 0;
          }
        }
      });
      
      const beneficioNeto = ingresosTotales - costesTotales;
      
      // Estad√≠sticas de distribuci√≥n
      const valoresVentas = ventas.map(v => v.precioFinal || v.total || 0);
      const stats = calcularEstadisticas(valoresVentas);
      
      // Actualizar dashboard
      document.getElementById('totalVentas').textContent = totalVentas;
      document.getElementById('ingresosTotales').textContent = ingresosTotales.toFixed(2) + ' ‚Ç¨';
      document.getElementById('costesTotales').textContent = costesTotales.toFixed(2) + ' ‚Ç¨';
      document.getElementById('beneficioNeto').textContent = beneficioNeto.toFixed(2) + ' ‚Ç¨';
      document.getElementById('media').textContent = stats.media.toFixed(2) + ' ‚Ç¨';
      document.getElementById('mediana').textContent = stats.mediana.toFixed(2) + ' ‚Ç¨';
      document.getElementById('moda').textContent = stats.moda.toFixed(2) + ' ‚Ç¨';
      document.getElementById('desviacion').textContent = stats.desviacion.toFixed(2) + ' ‚Ç¨';
      
      // An√°lisis por productos - ADAPTADO AL NUEVO FORMATO
      const productosStats = {};
      
      ventas.forEach(venta => {
        const nombreProducto = venta.producto || 'Producto Desconocido';
        
        if (!productosStats[nombreProducto]) {
          productosStats[nombreProducto] = { ventas: 0, ingresos: 0, costes: 0 };
        }
        
        productosStats[nombreProducto].ventas++;
        productosStats[nombreProducto].ingresos += venta.precioFinal || venta.total || 0;
        productosStats[nombreProducto].costes += venta.costo || 0;
        
        // Si es sistema anterior con casillas
        if (venta.casillas) {
          venta.casillas.forEach(casilla => {
            const nombreCasilla = casilla.nombre;
            if (!productosStats[nombreCasilla]) {
              productosStats[nombreCasilla] = { ventas: 0, ingresos: 0, costes: 0 };
            }
            productosStats[nombreCasilla].ventas++;
            productosStats[nombreCasilla].ingresos += casilla.valor;
            productosStats[nombreCasilla].costes += configuracion.costes[nombreCasilla] || 0;
          });
        }
      });
      
      // An√°lisis por decisiones - ADAPTADO
      const decisionesStats = {};
      ventas.forEach(venta => {
        let nombreDecision = 'Venta Est√°ndar';
        
        if (venta.decision && venta.decision.nombre) {
          nombreDecision = venta.decision.nombre.split(' (')[0];
        } else if (venta.tipo) {
          nombreDecision = venta.tipo.charAt(0).toUpperCase() + venta.tipo.slice(1);
        }
        
        if (!decisionesStats[nombreDecision]) {
          decisionesStats[nombreDecision] = { ventas: 0, ingresos: 0, costes: 0 };
        }
        
        decisionesStats[nombreDecision].ventas++;
        
        if (venta.decision && venta.decision.valor) {
          decisionesStats[nombreDecision].ingresos += venta.decision.valor;
        } else {
          decisionesStats[nombreDecision].ingresos += venta.precioFinal || venta.total || 0;
        }
        
        decisionesStats[nombreDecision].costes += configuracion.costeDecisiones[nombreDecision] || 0;
      });
      
      // An√°lisis por categor√≠as - ADAPTADO
      const categoriasStats = {};
      ventas.forEach(venta => {
        const nombreCategoria = venta.categoria || (venta.categoriaInfo ? venta.categoriaInfo.nombre : 'General');
        
        if (!categoriasStats[nombreCategoria]) {
          categoriasStats[nombreCategoria] = { ventas: 0, ingresos: 0, costes: 0 };
        }
        
        categoriasStats[nombreCategoria].ventas++;
        categoriasStats[nombreCategoria].ingresos += venta.precioFinal || venta.total || 0;
        categoriasStats[nombreCategoria].costes += venta.costo || 0;
        
        // Si es sistema anterior
        if (venta.casillas) {
          let costesVenta = 0;
          venta.casillas.forEach(casilla => {
            costesVenta += configuracion.costes[casilla.nombre] || 0;
          });
          if (venta.decision) {
            const nombreDecision = venta.decision.nombre.split(' (')[0];
            costesVenta += configuracion.costeDecisiones[nombreDecision] || 0;
          }
          categoriasStats[nombreCategoria].costes += costesVenta;
        }
      });
      
      // Llenar tablas
      llenarTabla('tablaCategorias', categoriasStats);
      llenarTabla('tablaProductos', productosStats);
      llenarTabla('tablaDecisiones', decisionesStats);
      
      // Mostrar detalle de ventas individuales
      mostrarDetalleVentas(ventas);
    }
    
    function mostrarDetalleVentas(ventas) {
      const detalleDiv = document.getElementById('ventasDetalle');
      
      if (ventas.length === 0) {
        detalleDiv.innerHTML = '<p>No hay ventas registradas</p>';
        return;
      }
      
      // Mostrar ventas m√°s recientes primero
      const ventasOrdenadas = [...ventas].reverse();
      
      detalleDiv.innerHTML = ventasOrdenadas.map((venta, index) => {
        const numeroVenta = ventas.length - index;
        
        // Detectar si es una venta del nuevo sistema
        const esNuevoSistema = venta.categoria && venta.producto && venta.emoji;
        
        if (esNuevoSistema) {
          // Nueva estructura de venta - Sistema simplificado
          let beneficioVenta = 0;
          let detallesEconomicos = '';
          
          if (venta.costo !== undefined && venta.beneficio !== undefined) {
            // Nuevo sistema con costo + beneficio fijo
            beneficioVenta = venta.beneficio;
            if (venta.vasoAjuste) {
              beneficioVenta += venta.vasoAjuste;
            }
            
            detallesEconomicos = `
              <div>
                <strong>üí∞ Desglose econ√≥mico:</strong><br>
                ‚Ä¢ Costo base: ‚Ç¨${venta.costo.toFixed(2)}<br>
                ‚Ä¢ Beneficio fijo: ‚Ç¨${venta.beneficio.toFixed(2)}<br>
                ${venta.vasoAjuste ? `‚Ä¢ Ajuste vaso: ‚Ç¨${venta.vasoAjuste.toFixed(2)}<br>` : ''}
                <strong>‚Ä¢ TOTAL: ‚Ç¨${venta.precioFinal.toFixed(2)}</strong>
              </div>
            `;
          } else {
            // Sistema anterior con porcentajes
            beneficioVenta = venta.precioFinal - venta.precioBase;
            detallesEconomicos = `
              <div>
                <strong>üí∞ Desglose econ√≥mico:</strong><br>
                ‚Ä¢ Precio base: ‚Ç¨${venta.precioBase.toFixed(2)}<br>
                ‚Ä¢ Incremento (+${venta.porcentaje}%): ‚Ç¨${venta.incremento.toFixed(2)}<br>
                <strong>‚Ä¢ TOTAL: ‚Ç¨${venta.precioFinal.toFixed(2)}</strong>
              </div>
            `;
          }
          
          // Informaci√≥n de ingredientes para productos preparados
          let ingredientesInfo = '';
          if (venta.tipo === 'preparado' && venta.ajustes && venta.ajustes.length > 0) {
            ingredientesInfo = `
              <div>
                <strong>üõ†Ô∏è Personalizaci√≥n:</strong><br>
                ${venta.ajustes.map(ajuste => `‚Ä¢ ${ajuste}`).join('<br>')}
                ${venta.vaso ? `<br><strong>ü•§ Vaso:</strong> ${venta.vaso}` : ''}
              </div>
            `;
          } else if (venta.vaso) {
            ingredientesInfo = `
              <div>
                <strong>ü•§ Vaso/Envase:</strong> ${venta.vaso}
              </div>
            `;
          }
          
          // Informaci√≥n de cantidad para vasos
          let cantidadInfo = '';
          if (venta.cantidad && venta.cantidad > 1) {
            cantidadInfo = `
              <div>
                <strong>üì¶ Cantidad:</strong> ${venta.cantidad} unidades
                ${venta.precioUnitario ? `<br><strong>üíµ Precio unitario:</strong> ‚Ç¨${venta.precioUnitario.toFixed(2)}` : ''}
              </div>
            `;
          }
          
          return `
            <div class="venta-detalle">
              <div class="venta-header">
                <span>üõí Venta #${numeroVenta} - ${venta.emoji} ${venta.producto.toUpperCase()}</span>
                <span>${new Date(venta.fecha).toLocaleString('es-ES')}</span>
              </div>
              
              <div class="venta-items">
                <div>
                  <strong>üì¶ Producto:</strong><br>
                  ‚Ä¢ ${venta.emoji} ${venta.producto}
                  <br><strong>üè∑Ô∏è Categor√≠a:</strong> ${venta.categoria}
                  <br><strong>üîß Tipo:</strong> ${venta.tipo === 'preparado' ? 'Personalizado' : venta.tipo === 'vaso' ? 'Vaso/Envase' : 'Est√°ndar'}
                </div>
                <div>
                  ${detallesEconomicos}
                </div>
              </div>
              
              ${ingredientesInfo ? `<div class="venta-items">${ingredientesInfo}</div>` : ''}
              ${cantidadInfo ? `<div class="venta-items">${cantidadInfo}</div>` : ''}
              
              <div class="venta-total">
                <strong>üí∏ TOTAL VENTA: ‚Ç¨${venta.precioFinal.toFixed(2)}</strong> | 
                <strong>üíö BENEFICIO: ‚Ç¨${beneficioVenta.toFixed(2)}</strong>
              </div>
            </div>
          `;
        } else {
          // Sistema antiguo - mantener compatibilidad
          let costesVenta = 0;
          if (venta.casillas) {
            venta.casillas.forEach(casilla => {
              costesVenta += configuracion.costes[casilla.nombre] || 0;
            });
          }
          if (venta.decision) {
            const nombreDecision = venta.decision.nombre.split(' (')[0];
            costesVenta += configuracion.costeDecisiones[nombreDecision] || 0;
          }
          
          const totalVenta = venta.total || 0;
          const beneficioVenta = totalVenta - costesVenta;
          
          const categoriaInfo = venta.categoriaInfo ? 
            `${venta.categoriaInfo.emoji} ${venta.categoriaInfo.nombre}` : 
            'üì¶ Categor√≠a General';
          
          return `
            <div class="venta-detalle">
              <div class="venta-header">
                <span>üõí Venta #${numeroVenta} - ${categoriaInfo}</span>
                <span>${venta.fecha}</span>
              </div>
              
              <div class="venta-items">
                <div>
                  <strong>üì¶ Productos seleccionados:</strong><br>
                  ${venta.casillas && venta.casillas.length > 0 
                    ? venta.casillas.map(c => `‚Ä¢ ${c.nombre}: ‚Ç¨${c.valor.toFixed(2)}`).join('<br>')
                    : '‚Ä¢ Sin productos'
                  }
                </div>
                <div>
                  <strong>üéØ Decisi√≥n elegida:</strong><br>
                  ‚Ä¢ ${venta.decision ? venta.decision.nombre : 'Sin decisi√≥n'}
                </div>
              </div>
              
              <div class="venta-items">
                <div>
                  <strong>üí∞ Desglose econ√≥mico:</strong><br>
                  ‚Ä¢ Subtotal: ‚Ç¨${(venta.subtotal || 0).toFixed(2)}<br>
                  ‚Ä¢ Extra (${configuracion.porcentajeBeneficio}%): ‚Ç¨${(venta.extra || 0).toFixed(2)}<br>
                  ‚Ä¢ Costes: ‚Ç¨${costesVenta.toFixed(2)}
                </div>
                <div class="venta-total">
                  <strong>üí∏ TOTAL VENTA: ‚Ç¨${totalVenta.toFixed(2)}</strong><br>
                  <strong style="color: ${beneficioVenta >= 0 ? '#4caf50' : '#f44336'}">üíö BENEFICIO: ‚Ç¨${beneficioVenta.toFixed(2)}</strong>
                </div>
              </div>
            </div>
          `;
        }
      }).join('');
    }
    
    function llenarTabla(idTabla, datos) {
      const tbody = document.querySelector('#' + idTabla + ' tbody');
      tbody.innerHTML = '';
      
      Object.entries(datos).forEach(([nombre, stats]) => {
        const beneficio = stats.ingresos - stats.costes;
        const margen = stats.ingresos > 0 ? (beneficio / stats.ingresos * 100) : 0;
        
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${nombre}</td>
          <td>${stats.ventas}</td>
          <td class="beneficio">${stats.ingresos.toFixed(2)} ‚Ç¨</td>
          <td class="coste">${stats.costes.toFixed(2)} ‚Ç¨</td>
          <td class="beneficio">${beneficio.toFixed(2)} ‚Ç¨</td>
          <td>${margen.toFixed(1)}%</td>
        `;
      });
    }
    
    function exportarDatos() {
      // Obtener datos desde el servidor
      Promise.all([
        fetch(API_CONFIG.getAPIEndpoint('datos')).then(r => r.json()),
        fetch(API_CONFIG.getAPIEndpoint('configuracion')).then(r => r.json())
      ])
      .then(([datosServidor, configServidor]) => {
        const dataStr = JSON.stringify({ 
          ventas: datosServidor.ventas || [], 
          configuracion: configServidor 
        }, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'analisis_ventas_' + new Date().toISOString().split('T')[0] + '.json';
        link.click();
        console.log('‚úÖ Datos exportados desde servidor');
      })
      .catch(error => {
        console.error('‚ùå Error al exportar datos del servidor, usando localStorage:', error);
        // Fallback a localStorage
        const ventas = JSON.parse(localStorage.getItem('ventas') || '[]');
        const dataStr = JSON.stringify({ ventas, configuracion }, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'analisis_ventas_' + new Date().toISOString().split('T')[0] + '.json';
        link.click();
      });
    }
    
    function exportarConfiguracion() {
      const configStr = JSON.stringify(configuracion, null, 2);
      const dataBlob = new Blob([configStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'configuracion.json';
      link.click();
      alert('üìÑ Descarga la configuraci√≥n y reemplaza el archivo configuracion.json');
    }
    
    function mostrarEditarCostes() {
      const panel = document.getElementById('panelCostes');
      panel.style.display = 'block';
      
      // Llenar productos
      const productosDiv = document.getElementById('costesProductos');
      productosDiv.innerHTML = '';
      Object.entries(configuracion.costes).forEach(([nombre, coste]) => {
        productosDiv.innerHTML += `
          <div style="margin: 0.5em 0;">
            <label>${nombre}: <input type="number" id="coste_${nombre}" value="${coste}" step="0.1" min="0"> ‚Ç¨</label>
          </div>
        `;
      });
      
      // Llenar decisiones
      const decisionesDiv = document.getElementById('costesDecisiones');
      decisionesDiv.innerHTML = '';
      Object.entries(configuracion.costeDecisiones).forEach(([nombre, coste]) => {
        decisionesDiv.innerHTML += `
          <div style="margin: 0.5em 0;">
            <label>${nombre}: <input type="number" id="decision_${nombre.replace(' ', '_')}" value="${coste}" step="0.1" min="0"> ‚Ç¨</label>
          </div>
        `;
      });
    }
    
    function guardarCostes() {
      // Actualizar costes de productos
      Object.keys(configuracion.costes).forEach(nombre => {
        const input = document.getElementById('coste_' + nombre);
        if (input) {
          configuracion.costes[nombre] = parseFloat(input.value) || 0;
        }
      });
      
      // Actualizar costes de decisiones
      Object.keys(configuracion.costeDecisiones).forEach(nombre => {
        const input = document.getElementById('decision_' + nombre.replace(' ', '_'));
        if (input) {
          configuracion.costeDecisiones[nombre] = parseFloat(input.value) || 0;
        }
      });
      
      // Guardar en localStorage
      localStorage.setItem('configuracionVentas', JSON.stringify(configuracion));
      
      // Actualizar dashboard
      cargarVentas();
      
      // Cerrar panel
      cerrarEditarCostes();
      
      // Mostrar confirmaci√≥n
      alert('‚úÖ Costes actualizados correctamente');
    }
    
    function cerrarEditarCostes() {
      document.getElementById('panelCostes').style.display = 'none';
    }
    
    function borrarTodo() {
      if (confirm('¬øEst√°s seguro de que quieres borrar todo el historial de ventas?')) {
        // Borrar del servidor
        fetch(API_CONFIG.getAPIEndpoint('ventas'), {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(resultado => {
          if (resultado.success) {
            console.log('‚úÖ Ventas borradas del servidor');
            // Tambi√©n borrar de localStorage como backup
            localStorage.removeItem('ventas');
            cargarVentas();
            alert('‚úÖ Historial de ventas borrado completamente');
          } else {
            throw new Error(resultado.error || 'Error desconocido');
          }
        })
        .catch(error => {
          console.error('‚ùå Error al borrar ventas del servidor:', error);
          // Fallback: borrar solo de localStorage
          localStorage.removeItem('ventas');
          cargarVentas();
          alert('‚ö†Ô∏è Ventas borradas solo localmente (error del servidor)');
        });
      }
    }
    
    function resetearSistema() {
      if (confirm('¬øResetear TODO el sistema? (configuraci√≥n + ventas)')) {
        localStorage.removeItem('ventas');
        localStorage.removeItem('configuracionVentas');
        crearConfiguracionDefecto();
        document.getElementById('porcentaje').value = configuracion.porcentajeBeneficio;
        cargarVentas();
        alert('‚úÖ Sistema reseteado completamente');
      }
    }
    
    function forzarInicializacion() {
      console.log('üî• Forzando inicializaci√≥n completa...');
      
      // Crear configuraci√≥n desde cero
      crearConfiguracionDefecto();
      
      // Actualizar interfaz
      document.getElementById('porcentaje').value = configuracion.porcentajeBeneficio;
      
      // Recargar ventas
      cargarVentas();
      
      console.log('‚úÖ Inicializaci√≥n forzada completada');
      alert('üî• Sistema inicializado forzosamente\n‚úÖ Configuraci√≥n recreada\n‚úÖ Datos cargados');
    }
    
    // Verificar sesi√≥n al cargar la p√°gina
    window.addEventListener('load', function() {
      verificarSesion();
      document.getElementById('passwordInput').focus();
    });
    
    // Cerrar sesi√≥n autom√°ticamente despu√©s de 1 hora de inactividad
    setInterval(function() {
      const sesionGuardada = localStorage.getItem('sesionVentas');
      if (sesionGuardada && Date.now() >= parseInt(sesionGuardada)) {
        cerrarSesion();
      }
    }, 60000); // Verificar cada minuto
    
    // Inicializar
    cargarConfiguracion().then(() => {
      cargarVentas();
      setInterval(cargarVentas, 5000);
    });
  </script>
</body>
</html>